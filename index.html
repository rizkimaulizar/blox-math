<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox Math Tycoon</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @keyframes bounce-short { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
      .animate-bounce-short { animation: bounce-short 0.5s ease-in-out infinite; }
      @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
      .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Star, RefreshCcw, Play, Lock, Plus, Minus, X, Divide, ChevronLeft, ChevronRight, Trophy, Crown, Skull, Volume2, Box, Shield, Zap, Sword, Hexagon, Medal, Terminal, Code, Circle, Gem, Ghost, Smile, Settings, Target, Disc, RotateCcw, RotateCw, Flame, Brain } from 'lucide-react';

        // ==========================================
        // BAGIAN 1: LOGIKA AUDIO (Diperbarui)
        // ==========================================
        const SOUND_PATHS = {
            combo: 'assets/sounds/combo.mp3',
            brainLevelUp: 'assets/sounds/brain-level-up.mp3',
            correct: 'assets/sounds/correct.mp3',
            clickMenu: '/assets/sounds/click-menu.mp3' // File baru ditambahkan
        };

        const audioFiles = {
            combo: new Audio(SOUND_PATHS.combo),
            brainLevelUp: new Audio(SOUND_PATHS.brainLevelUp),
            correct: new Audio(SOUND_PATHS.correct),
            clickMenu: new Audio(SOUND_PATHS.clickMenu) // Audio object baru
        };

        const playSFX = (type) => {
            // Logika untuk suara Menu (MP3)
            if (type === 'click-menu') { 
                audioFiles.clickMenu.currentTime = 0; 
                audioFiles.clickMenu.play().catch(() => {});
                return; // Keluar agar tidak memutar suara beep komputer
            }

            // Coba putar file MP3 jika ada
            if (type === 'combo') { audioFiles.combo.currentTime = 0; audioFiles.combo.play().catch(() => {}); }
            if (type === 'levelup') { audioFiles.brainLevelUp.currentTime = 0; audioFiles.brainLevelUp.play().catch(() => {}); }
            if (type === 'correct') { audioFiles.correct.currentTime = 0; audioFiles.correct.play().catch(() => {}); }

            // Fallback: Suara "Beep" Buatan Komputer (Untuk Gameplay/Kuis)
            if (typeof window === 'undefined') return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'click') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'finish') {
                const notes = [523.25, 659.25, 783.99, 1046.50]; const duration = 0.12; osc.disconnect(); notes.forEach((freq, i) => { const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type = 'triangle'; o.frequency.value = freq; const time = now + (i * duration); g.gain.setValueAtTime(0.1, time); g.gain.linearRampToValueAtTime(0.01, time + duration); o.start(time); o.stop(time + duration); });
            }
        };

        const playVoiceOver = (text) => {
            if (typeof window !== 'undefined' && window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                utterance.rate = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        };

        // ==========================================
        // BAGIAN 2: LOGIKA GAME (APP)
        // ==========================================
        function App() {
            const [appState, setAppState] = useState('home');
            const [difficulty, setDifficulty] = useState(null);
            const [operation, setOperation] = useState(null);
            const [selectedTable, setSelectedTable] = useState(null);
            
            const [questions, setQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(7); 
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [ringMidRot, setRingMidRot] = useState(0);    
            const [ringOutRot, setRingOutRot] = useState(0); 
            const [poppedBalloons, setPoppedBalloons] = useState([]); 
            const [combo, setCombo] = useState(0);
            const [comboMsg, setComboMsg] = useState('');
            const [showBrainLevelUp, setShowBrainLevelUp] = useState(false);

            let maxTime = 7;
            if (difficulty === 'pro') maxTime = 5;
            if (operation === 'hacker_algebra') maxTime = 9; 
            if (operation === 'hacker_circle') maxTime = 13; 
            if (operation === 'hacker_balloon') maxTime = 10; 

            useEffect(() => {
                const loadVoices = () => { if (typeof window !== 'undefined' && window.speechSynthesis) window.speechSynthesis.getVoices(); };
                loadVoices(); if (typeof window !== 'undefined' && window.speechSynthesis && window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadVoices;
            }, []);

            const getMotivationalMessage = (currentScore, totalQuestions, currentDifficulty) => {
                const percentage = (currentScore / totalQuestions) * 100;
                if (currentDifficulty === 'legend') {
                    if (percentage === 100) return "DI LUAR NALAR! Kamu pasti robot AI yang menyamar jadi manusia! Skor sempurna!";
                    if (percentage >= 80) return "LEVEL DEWA! Otakmu sudah upgrade ke versi terbaru ya? Cepat banget!";
                    if (percentage >= 50) return "SYSTEM ERROR! Skillmu oke, tapi masih perlu patch update biar makin ngebut!";
                    return "CRITICAL FAILURE! Jangan panik, reboot otakmu dan coba retas soalnya lagi!";
                } else if (currentDifficulty === 'pro') {
                    if (percentage === 100) return "GILA! Kamu makan kalkulator ya? Cepat banget! Einstein pun sungkem lihat kamu!";
                    if (percentage >= 80) return "SADIS! Teman sekelasmu pasti gemetar lihat skormu! Kamu calon penguasa sekolah!";
                    if (percentage >= 50) return "WADUH! Skill Pro kok segini? Malu dong sama tombol Enter! Ayo fokus, jangan AFK otaknya!";
                    return "GAWAT! Otakmu mulai karatan ya? Awas nanti digigit zombie kalau lambat mikir! GAS LATIHAN LAGI!";
                } else {
                    if (percentage === 100) return "Wah, otakmu pasti sebesar Galaksi! Kalkulator aja minder lihat kamu.";
                    if (percentage >= 80) return "Dikit lagi jadi Jenius! Teman-temanmu pasti gemetar kalau lihat nilaimu.";
                    if (percentage >= 50) return "Tapi masa cuma segini? Ayam tetangga sebelah aja bisa lebih jago lho! Ayo fokus!";
                    return "Otakmu masih tidur ya? Ayo bangunkan naga di dalam dirimu, jangan mau kalah sama kasur!";
                }
            };

            const getRandom = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            const createSingleQuestion = (type, table, modifier = null) => {
                let n1 = 0, n2 = 0, ans = 0, symbol = '';
                const getVal = () => modifier !== null ? modifier : Math.floor(Math.random() * 10) + 1;
                
                if (type === 'mul') { const base = table || Math.floor(Math.random() * 10) + 1; const multiplier = getVal(); n1 = base; n2 = multiplier; ans = n1 * n2; symbol = 'x'; } 
                else if (type === 'div') { if (table) { n2 = table; ans = getVal(); n1 = n2 * ans; } else { n1 = Math.floor(Math.random() * 10) + 1; const factors = []; for(let k=1; k<=n1; k++) if(n1%k===0) factors.push(k); n2 = factors[Math.floor(Math.random() * factors.length)]; ans = n1 / n2; } symbol = ':'; }
                else if (type === 'add') { if (table) { n1 = table; n2 = getVal(); } else { n1 = Math.floor(Math.random()*10)+1; n2 = Math.floor(Math.random()*10)+1; } ans = n1 + n2; symbol = '+'; }
                else if (type === 'sub') { if (table) { n2 = table; ans = getVal(); n1 = ans + n2; } else { n1 = Math.floor(Math.random()*10)+1; n2 = Math.floor(Math.random()*n1)+1; ans = n1 - n2; } symbol = '-'; }
                
                return { num1: n1, num2: n2, answer: ans, symbol };
            };

            const generateProQuestions = (opMode) => {
                const qList = [];
                const history = new Set();
                let totalQ = 20; let limitMedium = 5; let limitHard = 11; 
                if (opMode === 'mix_all') { totalQ = 25; limitMedium = 5; limitHard = 12; }

                for (let i = 0; i < totalQ; i++) {
                    let stage = 'easy';
                    if (i >= limitMedium) stage = 'medium'; if (i >= limitHard) stage = 'hard';
                    let valid = false; let q = {}; let attempts = 0;

                    while (!valid && attempts < 100) {
                        attempts++;
                        let currentOp = 'add';
                        if (opMode === 'mix_add_sub') currentOp = Math.random() > 0.5 ? 'add' : 'sub';
                        else if (opMode === 'mix_mul_div') currentOp = Math.random() > 0.5 ? 'mul' : 'div';
                        else { const r = Math.random(); if (r < 0.25) currentOp = 'add'; else if (r < 0.5) currentOp = 'sub'; else if (r < 0.75) currentOp = 'mul'; else currentOp = 'div'; }

                        let n1 = 0, n2 = 0, ans = 0;
                        if (stage === 'easy') { n1 = getRandom(2, 9); n2 = getRandom(2, 9); } 
                        else if (stage === 'medium') { n1 = getRandom(10, 20); n2 = getRandom(2, 9); } 
                        else { n1 = getRandom(21, 50); n2 = getRandom(2, 9); }

                        if (currentOp === 'add') { ans = n1 + n2; } 
                        else if (currentOp === 'sub') { if (n1 < n2) [n1, n2] = [n2, n1]; ans = n1 - n2; } 
                        else if (currentOp === 'mul') { if (stage === 'hard') n1 = getRandom(12, 19); if (Math.random() > 0.5) [n1, n2] = [n2, n1]; ans = n1 * n2; } 
                        else if (currentOp === 'div') { 
                            let qVal = 0; if (stage === 'easy') qVal = getRandom(2, 9); else if (stage === 'medium') qVal = getRandom(5, 15); else qVal = getRandom(10, 25);
                            n2 = getRandom(2, 9); n1 = n2 * qVal; ans = qVal;
                            if (stage === 'hard' && (n1 < 10 || n1 > 99)) continue; 
                        }

                        if (ans <= 1) continue; if (currentOp === 'div' && n1 === n2) continue; 
                        const sig = `${n1}${currentOp}${n2}`;
                        if (!history.has(sig)) { history.add(sig); let symbol = ''; if(currentOp==='add') symbol='+'; if(currentOp==='sub') symbol='-'; if(currentOp==='mul') symbol='x'; if(currentOp==='div') symbol=':'; q = { num1: n1, num2: n2, answer: ans, symbol }; valid = true; }
                    }
                    qList.push(q);
                }
                return qList;
            };

            const createHackerQuestion = (index) => {
                let n1 = 0, n2 = 0;
                if (index < 5) { n1 = getRandom(2, 9); n2 = getRandom(2, 9); } 
                else if (index < 10) { n1 = getRandom(11, 19); n2 = getRandom(2, 5); } 
                else { const bases = [20, 25, 30, 40, 50, 60]; n1 = bases[getRandom(0, bases.length - 1)]; n2 = getRandom(2, 5); }
                if (Math.random() > 0.5) [n1, n2] = [n2, n1];
                const ans = n1 * n2;
                const missingPart = Math.floor(Math.random() * 3); 
                let answer = 0;
                if (missingPart === 0) answer = n1; else if (missingPart === 1) answer = n2; else answer = ans;

                const optionsSet = new Set(); optionsSet.add(answer);
                while (optionsSet.size < 10) { let fake = getRandom(Math.max(1, answer - 20), answer + 20); if (fake !== answer) optionsSet.add(fake); }
                const rawOptions = Array.from(optionsSet);
                for (let i = rawOptions.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [rawOptions[i], rawOptions[j]] = [rawOptions[j], rawOptions[i]]; }

                const optionsWithPos = rawOptions.map((val, i) => {
                    const baseAngle = i * 36; const randomOffset = getRandom(-15, 15); const angleRad = (baseAngle + randomOffset) * (Math.PI / 180);
                    const radius = getRandom(220, 260); const x = Math.cos(angleRad) * radius; const y = Math.sin(angleRad) * radius;
                    const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-orange-500'];
                    const color = colors[getRandom(0, colors.length - 1)];
                    return { val, x, y, color };
                });
                return { num1: n1, num2: n2, product: ans, missingPart: missingPart, answer: answer, options: optionsWithPos };
            };

            const createAlgebraQuestion = () => {
                const iconsPool = ['sword', 'shield', 'gem', 'ghost', 'smile', 'box', 'zap', 'star', 'trophy', 'crown'];
                for (let i = iconsPool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [iconsPool[i], iconsPool[j]] = [iconsPool[j], iconsPool[i]]; }
                let val1 = 0, val2 = 0, answer = 0, symbol = ""; let isValid = false;
                while (!isValid) {
                    const ops = ['add', 'sub', 'mul', 'div']; const op = ops[Math.floor(Math.random() * ops.length)];
                    val1 = getRandom(1, 10); val2 = getRandom(1, 10);
                    if (val1 === val2) continue;
                    if (op === 'add') { answer = val1 + val2; symbol = "+"; if (answer !== 1) isValid = true; } 
                    else if (op === 'sub') { if (val1 < val2) [val1, val2] = [val2, val1]; answer = val1 - val2; symbol = "-"; if (answer !== 1) isValid = true; } 
                    else if (op === 'mul') { answer = val1 * val2; symbol = "x"; if (answer !== 1) isValid = true; } 
                    else if (op === 'div') { if (val1 % val2 === 0) { answer = val1 / val2; symbol = ":"; if (answer !== 1) isValid = true; } }
                }
                return { type: 'algebra', keyMap: iconsPool, val1: val1, val2: val2, symbol: symbol, answer: answer };
            };

            const createCircleQuestion = (index) => {
                const ops = ['add', 'sub', 'mul', 'div']; const op = ops[Math.floor(Math.random() * ops.length)];
                let n1 = 0, n2 = 0, ans = 0, symbol = '';
                const isHard = index >= 10;
                const getSingleDigit = () => getRandom(1, 9); const getTwoDigit = () => getRandom(10, 50);

                if (op === 'mul') { if (isHard) { n1 = getTwoDigit(); n2 = getRandom(2, 5); } else { n1 = getSingleDigit(); n2 = getSingleDigit(); } ans = n1 * n2; symbol = 'x'; } 
                else if (op === 'div') { if (isHard) { n2 = getRandom(2, 9); ans = getTwoDigit(); n1 = n2 * ans; } else { n2 = getSingleDigit(); ans = getSingleDigit(); n1 = n2 * ans; } if (n1 > 50) { n2 = getRandom(2, 5); ans = getRandom(2, 9); n1 = n2 * ans; } symbol = ':'; } 
                else if (op === 'add') { if (isHard) { n1 = getTwoDigit(); n2 = getSingleDigit(); } else { n1 = getSingleDigit(); n2 = getSingleDigit(); } ans = n1 + n2; symbol = '+'; } 
                else { if (isHard) { n1 = getTwoDigit(); n2 = getSingleDigit(); ans = n1 - n2; } else { const a = getSingleDigit(); const b = getSingleDigit(); n1 = Math.max(a, b); n2 = Math.min(a, b); ans = n1 - n2; } symbol = '-'; }

                const midOpts = new Set(); midOpts.add(n2); while (midOpts.size < 10) midOpts.add(getRandom(1, 50));
                const midArr = Array.from(midOpts); for (let i = midArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [midArr[i], midArr[j]] = [midArr[j], midArr[i]]; }
                const outArr = Array(10).fill(null); outArr[0] = ans; for (let i = outArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [outArr[i], outArr[j]] = [outArr[j], outArr[i]]; }
                return { type: 'circle', num1: n1, num2: n2, ans: ans, symbol: symbol, midOptions: midArr, outOptions: outArr };
            };

            const generateQuestions = (op, table) => {
                if (op === 'mix_add_sub' || op === 'mix_mul_div' || op === 'mix_all') return generateProQuestions(op);
                const qList = [];
                let count = 10;
                if (op === 'hacker_balloon') { count = 15; for (let i = 0; i < count; i++) qList.push(createHackerQuestion(i)); return qList; }
                if (op === 'hacker_algebra') { count = 15; for (let i = 0; i < count; i++) qList.push(createAlgebraQuestion()); return qList; }
                if (op === 'hacker_circle') { count = 15; for (let i = 0; i < count; i++) qList.push(createCircleQuestion(i)); return qList; }

                let uniqueModifiers = [];
                if (table !== null) { uniqueModifiers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; for (let i = uniqueModifiers.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [uniqueModifiers[i], uniqueModifiers[j]] = [uniqueModifiers[j], uniqueModifiers[i]]; } }
                for (let i = 0; i < count; i++) {
                let qType = 'add'; 
                if (op && ['add','sub','mul','div'].includes(op)) qType = op;
                let currentModifier = null; if (table !== null && i < uniqueModifiers.length) currentModifier = uniqueModifiers[i];
                qList.push(createSingleQuestion(qType, table, currentModifier));
                }
                return qList;
            };

            const selectDifficulty = (diff) => { playSFX('click-menu'); setDifficulty(diff); if (diff === 'rookie') setAppState('rookie_menu'); if (diff === 'pro') setAppState('pro_menu'); if (diff === 'legend') setAppState('hacker_menu'); };
            const selectOperation = (op) => { 
                playSFX('click-menu'); setOperation(op); 
                if (op === 'hacker_circle') { setRingMidRot(Math.floor(Math.random() * 10)); setRingOutRot(Math.floor(Math.random() * 10)); }
                if (op && ['mix_add_sub', 'mix_mul_div', 'mix_all', 'hacker_balloon', 'hacker_algebra', 'hacker_circle'].includes(op)) startIntro(null); 
                else setAppState('table_select'); 
            };
            const startIntro = (table) => { playSFX('click-menu'); setSelectedTable(table); setAppState('intro'); };
            const startGame = () => { 
                playSFX('click-menu'); 
                const newQuestions = generateQuestions(operation, selectedTable); 
                setQuestions(newQuestions); 
                setCurrentQuestionIndex(0); 
                setScore(0); 
                setCombo(0); 
                setComboMsg(''); 
                setShowBrainLevelUp(false);
                setAppState('playing'); 
                setTimeLeft(maxTime); 
                setUserAnswer(''); 
                setFeedback(null); 
                setRingMidRot(Math.floor(Math.random() * 10)); 
                setRingOutRot(Math.floor(Math.random() * 10)); 
                setPoppedBalloons([]); 
            };
            // NOTE: handleAnswer dan deleteAnswer tetap menggunakan 'click' (default beep) karena ini saat kuis berjalan
            const handleAnswer = (val) => { playSFX('click'); if (feedback) return; setUserAnswer(prev => { if (prev.length > 3) return prev; return prev + val; }); };
            const deleteAnswer = () => { playSFX('click'); if (feedback) return; setUserAnswer(prev => prev.slice(0, -1)); };

            const rotateRing = (ring, dir) => {
                playSFX('rotate');
                if (ring === 'mid') { setRingMidRot(prev => dir === 'cw' ? prev + 1 : prev - 1); } 
                else { setRingOutRot(prev => dir === 'cw' ? prev + 1 : prev - 1); }
            };

            const submitCircleAnswer = () => {
                if (feedback) return;
                const currentQ = questions[currentQuestionIndex];
                const getTopIndex = (rot) => { const mod = rot % 10; return (10 - (mod < 0 ? mod + 10 : mod)) % 10; };
                const midTopIndex = getTopIndex(ringMidRot);
                const outTopIndex = getTopIndex(ringOutRot);
                const selectedMid = currentQ.midOptions[midTopIndex];
                const selectedOut = currentQ.outOptions[outTopIndex];
                const isCorrect = selectedMid === currentQ.num2 && selectedOut === currentQ.ans;
                
                if (isCorrect) { 
                    setScore(s => s + 1); setFeedback('correct'); playSFX('correct'); 
                } else { 
                    setFeedback('wrong'); playSFX('wrong'); 
                }
                setTimeout(() => nextQuestion(), 1000);
            };

            const handleBalloonClick = (val, index) => {
                if (feedback === 'correct' || feedback === 'wrong' || feedback === 'timeout' || poppedBalloons.includes(index)) return;
                const currentQ = questions[currentQuestionIndex];
                if (val === currentQ.answer) {
                    setScore(s => s + 1); setFeedback('correct'); playSFX('correct'); setTimeout(() => nextQuestion(), 1000);
                } else {
                    playSFX('pop'); setPoppedBalloons(prev => [...prev, index]); setFeedback('wrong'); setTimeout(() => nextQuestion(), 800); 
                }
            };

            const submitAnswer = () => {
                if (feedback) return; if (userAnswer === '') return;
                const currentQ = questions[currentQuestionIndex]; 
                let isCorrect = parseInt(userAnswer) === currentQ.answer;

                if (isCorrect) { 
                    const newScore = score + 1;
                    setScore(newScore); 
                    setFeedback('correct'); 
                    playSFX('correct'); 
                    
                    if (difficulty === 'rookie' && newScore === questions.length) {
                        setShowBrainLevelUp(true);
                        playSFX('levelup');
                        setTimeout(() => setShowBrainLevelUp(false), 3000);
                    }
                    if (difficulty === 'rookie') {
                        const newCombo = combo + 1;
                        setCombo(newCombo);
                        if (newCombo > 1) playSFX('combo');
                        if (newCombo === 3) setComboMsg("Keren!");
                        else if (newCombo === 5) setComboMsg("Hebat!");
                        else if (newCombo >= 8) setComboMsg("Otak Kamu Panas ðŸ”¥");
                        else setComboMsg("");
                    }
                } else { 
                    setFeedback('wrong'); 
                    playSFX('wrong'); 
                    if (difficulty === 'rookie') { setCombo(0); setComboMsg(""); }
                }
                setTimeout(() => nextQuestion(), 1000);
            };

            const nextQuestion = () => {
                if (currentQuestionIndex < questions.length - 1) { 
                    setCurrentQuestionIndex(prev => prev + 1); setUserAnswer(''); setTimeLeft(maxTime); setFeedback(null); setRingMidRot(Math.floor(Math.random() * 10)); setRingOutRot(Math.floor(Math.random() * 10)); setPoppedBalloons([]);
                } else { 
                    setAppState('result'); 
                }
            };

            useEffect(() => {
                let timer;
                if (appState === 'playing' && feedback !== 'correct' && feedback !== 'wrong' && timeLeft > 0) { 
                timer = setInterval(() => { 
                    setTimeLeft(prev => { 
                        if (prev <= 0.1) { clearInterval(timer); setFeedback('timeout'); playSFX('wrong'); if (difficulty === 'rookie') { setCombo(0); setComboMsg(""); } setTimeout(() => nextQuestion(), 1000); return 0; } 
                        return prev - 0.1; 
                    }); 
                }, 100);
                }
                return () => clearInterval(timer);
            }, [appState, timeLeft, feedback]);

            useEffect(() => {
                if (appState === 'result') { playSFX('finish'); const message = getMotivationalMessage(score, questions.length, difficulty); const timeout = setTimeout(() => { playVoiceOver(message); }, 1200); return () => { clearTimeout(timeout); window.speechSynthesis.cancel(); }; }
            }, [appState, score, questions.length, difficulty]);

            const renderIcon = (iconName, size = 32) => {
                if (iconName === 'sword') return <Sword size={size} className="text-blue-400 fill-blue-400/20" />;
                if (iconName === 'shield') return <Shield size={size} className="text-gray-300 fill-gray-300/20" />;
                if (iconName === 'gem') return <Gem size={size} className="text-green-400 fill-green-400/20" />;
                if (iconName === 'ghost') return <Ghost size={size} className="text-white fill-white/20" />;
                if (iconName === 'smile') return <Smile size={size} className="text-yellow-400 fill-yellow-400/20" />;
                if (iconName === 'box') return <Box size={size} className="text-orange-400 fill-orange-400/20" />;
                if (iconName === 'zap') return <Zap size={size} className="text-purple-400 fill-purple-400/20" />;
                if (iconName === 'star') return <Star size={size} className="text-red-400 fill-red-400/20" />;
                if (iconName === 'trophy') return <Trophy size={size} className="text-cyan-400 fill-cyan-400/20" />;
                if (iconName === 'crown') return <Crown size={size} className="text-pink-400 fill-pink-400/20" />;
                return <Circle size={size} />;
            };

            // RENDER TAMPILAN
            if (appState === 'home') {
                return (
                <div className="min-h-screen bg-gradient-to-b from-[#0099ff] to-[#aeeaff] flex flex-col items-center justify-center p-6 font-sans relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20" style={{ backgroundImage: `radial-gradient(#ffffff 6px, transparent 6px), radial-gradient(#ffffff 6px, transparent 6px)`, backgroundSize: '50px 50px', backgroundPosition: '0 0, 25px 25px' }}></div>
                    <div className="text-center mb-8 z-10 animate-bounce-short relative">
                        <h1 className="text-6xl font-black text-white mb-2 tracking-tighter transform -rotate-2" style={{ fontFamily: '"Arial Black", "Arial", sans-serif', textShadow: '4px 4px 0 #000, -2px -2px 0 #0066cc', WebkitTextStroke: '2px black' }}>BLOX <span className="text-[#ffd700]">MATH</span></h1>
                        <div className="inline-block bg-white/20 px-6 py-2 rounded-xl text-white font-black text-sm border-2 border-white/50 backdrop-blur-md shadow-xl transform rotate-1 mt-2">VERSI TYCOON</div>
                    </div>
                    <div className="flex flex-col gap-4 w-full max-w-sm z-10">
                        <button onClick={() => selectDifficulty('rookie')} className="group relative bg-[#00b06f] hover:bg-[#00c07f] text-white p-4 rounded-xl border-b-8 border-[#008c5a] active:border-b-0 active:translate-y-2 transition-all flex items-center justify-between shadow-2xl"><div className="flex items-center gap-4"><div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><Box size={32} className="text-white" /></div><div className="text-left"><div className="text-2xl font-black uppercase drop-shadow-md">NOOB</div><div className="text-green-100 text-xs font-bold uppercase">Mode Santai</div></div></div><div className="bg-black/20 px-3 py-1 rounded text-xs font-bold border border-white/20">LVL 1</div></button>
                        <button onClick={() => selectDifficulty('pro')} className="group relative bg-[#2a52be] hover:bg-[#3a62ce] text-white p-4 rounded-xl border-b-8 border-[#1a329e] active:border-b-0 active:translate-y-2 transition-all flex items-center justify-between shadow-2xl"><div className="flex items-center gap-4"><div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><Shield size={32} /></div><div className="text-left"><div className="text-2xl font-black uppercase drop-shadow-md">PRO</div><div className="text-blue-100 text-xs font-bold uppercase">Mode Serius</div></div></div><div className="bg-black/20 px-3 py-1 rounded text-xs font-bold border border-white/20">LVL 10</div></button>
                        <button onClick={() => selectDifficulty('legend')} className="group relative bg-[#111827] hover:bg-[#1f2937] text-white p-4 rounded-xl border-b-8 border-black active:border-b-0 active:translate-y-2 transition-all flex items-center justify-between shadow-2xl"><div className="flex items-center gap-4"><div className="bg-[#00ff41] p-2 rounded-lg backdrop-blur-sm animate-pulse"><Terminal size={32} className="text-black" /></div><div className="text-left"><div className="text-2xl font-black uppercase drop-shadow-md text-[#00ff41]">HACKER</div><div className="text-green-900 bg-[#00ff41] px-1 rounded text-[10px] font-bold uppercase inline-block">Glitch Mode</div></div></div><div className="bg-[#00ff41]/20 px-3 py-1 rounded text-xs font-bold text-[#00ff41] border border-[#00ff41]/50">LVL 99</div></button>
                    </div>
                </div>
                );
            }

            if (appState === 'rookie_menu' || appState === 'pro_menu') {
                const isPro = appState === 'pro_menu';
                return (
                <div className={`min-h-screen ${isPro ? 'bg-[#2a52be]' : 'bg-[#00b06f]'} flex flex-col items-center justify-center p-4`}>
                    <div className="w-full max-w-md mb-6 flex items-center z-10 relative"><button onClick={() => { playSFX('click-menu'); setAppState('home'); }} className={`p-3 rounded-md text-white border-b-4 active:border-b-0 active:translate-y-1 transition-all ${isPro ? 'bg-[#1a329e] border-[#102060]' : 'bg-[#008c5a] border-[#006e46]'}`}><ChevronLeft size={28} strokeWidth={3} /></button><h2 className="text-3xl font-black text-white ml-4 drop-shadow-md uppercase tracking-tight">MENU {isPro ? 'PRO' : 'NOOB'}</h2></div>
                    <div className={`grid ${isPro ? 'grid-cols-1' : 'grid-cols-2'} gap-4 w-full max-w-md z-10`}>
                        {!isPro ? (['add','sub','mul','div'].map(op => (<button key={op} onClick={() => selectOperation(op)} className="bg-[#393b3d] border-[#232527] border-b-8 hover:brightness-110 active:border-b-0 active:translate-y-2 aspect-square rounded-md flex flex-col items-center justify-center gap-2 group transition-all"><div className={`p-2 rounded group-hover:scale-110 transition-transform ${op==='add'?'text-blue-400':op==='sub'?'text-red-400':op==='mul'?'text-yellow-400':'text-purple-400'}`}>{op==='add'?<Plus size={40} strokeWidth={4}/>:op==='sub'?<Minus size={40} strokeWidth={4}/>:op==='mul'?<X size={40} strokeWidth={4}/>:<Divide size={40} strokeWidth={4}/>}</div><span className="text-xl font-black text-white uppercase">{op==='add'?'TAMBAH':op==='sub'?'KURANG':op==='mul'?'KALI':'BAGI'}</span></button>))) : (<><button onClick={() => selectOperation('mix_add_sub')} className="bg-[#393b3d] text-white p-5 rounded-md border-b-8 border-[#232527] active:translate-y-2 flex items-center justify-between"><div className="flex gap-4"><div className="bg-[#00b0f4] p-3 rounded text-white"><Sword size={32}/></div><div className="text-left"><div className="text-2xl font-black">ADVENTURE</div><div className="text-xs font-bold text-gray-400">+ & -</div></div></div><div className="bg-black/30 px-3 py-1 rounded">20 SOAL</div></button><button onClick={() => selectOperation('mix_mul_div')} className="bg-[#393b3d] text-white p-5 rounded-md border-b-8 border-[#232527] active:translate-y-2 flex items-center justify-between"><div className="flex gap-4"><div className="bg-[#e29e00] p-3 rounded text-white"><Hexagon size={32}/></div><div className="text-left"><div className="text-2xl font-black">DUNGEON</div><div className="text-xs font-bold text-gray-400">x & :</div></div></div><div className="bg-black/30 px-3 py-1 rounded">20 SOAL</div></button><button onClick={() => selectOperation('mix_all')} className="bg-[#393b3d] text-white p-5 rounded-md border-b-8 border-[#232527] active:translate-y-2 flex items-center justify-between"><div className="flex gap-4"><div className="bg-[#f44336] p-3 rounded text-white"><Skull size={32}/></div><div className="text-left"><div className="text-2xl font-black">BOSS RAID</div><div className="text-xs font-bold text-gray-400">SEMUA</div></div></div><div className="bg-black/30 px-3 py-1 rounded">25 SOAL</div></button></>)}
                    </div>
                </div>
                );
            }

            if (appState === 'hacker_menu') {
                return (
                <div className="min-h-screen bg-[#0d1117] flex flex-col items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'linear-gradient(0deg, transparent 24%, #00ff41 25%, #00ff41 26%, transparent 27%, transparent 74%, #00ff41 75%, #00ff41 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, #00ff41 25%, #00ff41 26%, transparent 27%, transparent 74%, #00ff41 75%, #00ff41 76%, transparent 77%, transparent)', backgroundSize: '50px 50px' }}></div>
                    <div className="w-full max-w-md mb-6 flex items-center z-10 relative"><button onClick={() => { playSFX('click-menu'); setAppState('home'); }} className="bg-[#161b22] p-3 rounded-md text-[#00ff41] border border-[#00ff41] hover:bg-[#00ff41] hover:text-black transition-all"><ChevronLeft size={28} strokeWidth={3} /></button><h2 className="text-3xl font-black text-[#00ff41] ml-4 drop-shadow-[0_0_10px_#00ff41] uppercase tracking-tight font-mono">TERMINAL</h2></div>
                    <div className="flex flex-col gap-4 w-full max-w-md z-10">
                        <button onClick={() => selectOperation('hacker_balloon')} className="group relative bg-[#161b22] hover:bg-[#00ff41]/10 text-white p-5 rounded-md border border-[#00ff41] active:translate-y-1 transition-all flex items-center justify-between shadow-[0_0_15px_rgba(0,255,65,0.1)]"><div className="flex items-center gap-4"><div className="bg-[#00ff41]/20 p-3 rounded-full border border-[#00ff41] animate-pulse"><Circle size={32} className="text-[#00ff41]" /></div><div className="text-left"><div className="text-2xl font-black uppercase text-[#00ff41] font-mono">BALON HACKER</div><div className="text-[#00ff41]/70 text-xs font-bold uppercase font-mono">ISI KOSONG â€¢ 10 DETIK</div></div></div></button>
                        <button onClick={() => selectOperation('hacker_algebra')} className="group relative bg-[#161b22] hover:bg-[#00ff41]/10 text-white p-5 rounded-md border border-[#00ff41] active:translate-y-1 transition-all flex items-center justify-between shadow-[0_0_15px_rgba(0,255,65,0.1)]"><div className="flex items-center gap-4"><div className="bg-[#00ff41]/20 p-3 rounded-full border border-[#00ff41] animate-pulse"><Code size={32} className="text-[#00ff41]" /></div><div className="text-left"><div className="text-2xl font-black uppercase text-[#00ff41] font-mono">CODE BREAKER</div><div className="text-[#00ff41]/70 text-xs font-bold uppercase font-mono">PEMECAH SANDI â€¢ 9 DETIK</div></div></div></button>
                        <button onClick={() => selectOperation('hacker_circle')} className="group relative bg-[#161b22] hover:bg-[#00ff41]/10 text-white p-5 rounded-md border border-[#00ff41] active:translate-y-1 transition-all flex items-center justify-between shadow-[0_0_15px_rgba(0,255,65,0.1)]"><div className="flex items-center gap-4"><div className="bg-[#00ff41]/20 p-3 rounded-full border border-[#00ff41] animate-pulse"><Settings size={32} className="text-[#00ff41]" /></div><div className="text-left"><div className="text-2xl font-black uppercase text-[#00ff41] font-mono">CYBER CIRCLE</div><div className="text-[#00ff41]/70 text-xs font-bold uppercase font-mono">PUTAR & COCOKKAN â€¢ 13 DETIK</div></div></div></button>
                    </div>
                </div>
                );
            }

            if (appState === 'table_select') {
                return (
                <div className="min-h-screen bg-[#e29e00] flex flex-col items-center justify-center p-4">
                    <div className="bg-[#232527] p-6 rounded-md shadow-xl max-w-md w-full text-center border-b-8 border-black z-10">
                    <div className="flex justify-between items-center mb-6"><button onClick={() => { playSFX('click-menu'); setAppState('rookie_menu'); }} className="text-gray-400 hover:text-white font-black">{'< KEMBALI'}</button><h2 className="text-2xl font-black text-white uppercase">Pilih Angka</h2></div>
                    <div className="grid grid-cols-2 gap-3">{[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (<button key={num} onClick={() => startIntro(num)} className="bg-[#00b0f4] hover:bg-[#34c3ff] active:translate-y-1 active:border-b-0 text-white text-2xl font-black py-3 rounded-md border-b-4 border-[#0077a6] transition-all">LEVEL {num}</button>))}</div>
                    </div>
                </div>
                );
            }

            if (appState === 'intro') {
                let title = ""; let bgColor = "bg-[#00b0f4]"; let totalQuestions = 10;
                if (operation === 'add') { title = selectedTable ? `TAMBAH: LEVEL ${selectedTable}` : "OBBY: TAMBAH"; bgColor = "bg-[#00b0f4]"; }
                else if (operation === 'sub') { title = selectedTable ? `KURANG: LEVEL ${selectedTable}` : "OBBY: KURANG"; bgColor = "bg-[#f44336]"; }
                else if (operation === 'mul') { title = selectedTable ? `KALI: LEVEL ${selectedTable}` : `OBBY: KALI`; bgColor = "bg-[#e29e00]"; }
                else if (operation === 'div') { title = selectedTable ? `BAGI: LEVEL ${selectedTable}` : "OBBY: BAGI"; bgColor = "bg-[#9059ff]"; }
                else if (operation === 'mix_add_sub') { title = "ADV: CAMPURAN 1"; bgColor = "bg-[#2a52be]"; totalQuestions = 20; }
                else if (operation === 'mix_mul_div') { title = "DUNG: CAMPURAN 2"; bgColor = "bg-[#2a52be]"; totalQuestions = 20; }
                else if (operation === 'mix_all') { title = "RAID: SEMUA"; bgColor = "bg-[#2a52be]"; totalQuestions = 25; }
                else if (operation === 'hacker_balloon') { title = "BALON HACKER"; bgColor = "bg-[#0d1117]"; totalQuestions = 15; }
                else if (operation === 'hacker_algebra') { title = "CODE BREAKER"; bgColor = "bg-[#0d1117]"; totalQuestions = 15; }
                else if (operation === 'hacker_circle') { title = "CYBER CIRCLE"; bgColor = "bg-[#0d1117]"; totalQuestions = 15; }
                const isHacker = ['hacker_balloon', 'hacker_algebra', 'hacker_circle'].includes(operation || '');

                return (
                <div className={`min-h-screen ${bgColor} flex flex-col items-center justify-center p-4`}>
                    <div className="absolute inset-0 opacity-20" style={{ backgroundImage: 'linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000), linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000)', backgroundSize: '40px 40px', backgroundPosition: '0 0, 20px 20px' }}></div>
                    <div className={`p-8 rounded-md shadow-2xl max-w-sm w-full text-center border-4 z-10 ${isHacker ? 'bg-[#161b22] border-[#00ff41]' : 'bg-[#232527] border-white'}`}>
                    <h2 className={`text-2xl font-black mb-2 uppercase tracking-wide ${isHacker ? 'text-[#00ff41] font-mono' : 'text-white'}`}>{title}</h2>
                    <div className={`p-4 rounded mb-6 border-2 ${isHacker ? 'bg-black border-[#00ff41]/50' : 'bg-[#393b3d] border-[#505254]'}`}>
                        <p className={`font-bold ${isHacker ? 'text-[#00ff41]' : 'text-gray-300'}`}>MISI:</p><p className="text-white text-lg">{operation === 'hacker_balloon' ? 'Isi Balon Kosong' : operation === 'hacker_algebra' ? 'Pecahkan Kode' : operation === 'hacker_circle' ? 'Putar Roda Gigi' : `Jawab ${totalQuestions} Soal`}</p><div className="h-px bg-gray-600 my-2"></div><p className={`font-bold ${isHacker ? 'text-[#00ff41]' : 'text-gray-300'}`}>TIMER:</p><p className={`${isHacker ? 'text-[#00ff41] font-mono' : 'text-[#f44336]'} font-black text-xl`}>{maxTime} Detik</p>
                    </div>
                    <button onClick={startGame} className={`w-full text-3xl font-black py-4 rounded-md active:translate-y-2 transition-all flex items-center justify-center gap-2 uppercase ${isHacker ? 'bg-[#00ff41] text-black hover:bg-[#00ff41]/80 shadow-[0_0_15px_#00ff41]' : 'bg-[#00b06f] hover:bg-[#00c07f] text-white border-b-8 border-[#008c5a] active:border-b-0'}`}>GAS KAN!</button>
                    <button onClick={() => { playSFX('click-menu'); if (difficulty === 'legend') setAppState('hacker_menu'); else if (difficulty === 'pro') setAppState('pro_menu'); else if (selectedTable) setAppState('table_select'); else setAppState('rookie_menu'); }} className="mt-6 text-gray-400 font-bold hover:text-white uppercase text-sm">Batal Misi</button>
                    </div>
                </div>
                );
            }

            if (appState === 'playing') {
                const currentQ = questions[currentQuestionIndex];
                const progressPercent = (timeLeft / maxTime) * 100;
                const totalQ = questions.length;
                let mainColor = "bg-[#393b3d]"; 
                if (feedback === 'correct') mainColor = "bg-[#00b06f]"; 
                if (feedback === 'wrong' || feedback === 'timeout') mainColor = "bg-[#f44336]";
                const isHacker = difficulty === 'legend';
                let bgClass = isHacker ? 'bg-[#0d1117]' : (feedback ? mainColor : 'bg-[#232527]');
                if (isHacker && (feedback === 'correct')) bgClass = 'bg-[#00b06f]';
                if (isHacker && (feedback === 'wrong' || feedback === 'timeout')) bgClass = 'bg-[#f44336]';
                const borderClass = feedback === 'correct' ? 'border-[#00ff41] animate-pulse' : (feedback === 'wrong' || feedback === 'timeout' ? 'border-[#f44336] animate-pulse' : 'border-[#30363d]');

                return (
                <div className={`min-h-screen ${bgClass} transition-colors duration-200 flex flex-col items-center justify-center p-4 font-sans`}>
                    <div className={`w-full max-w-md flex justify-between items-center mb-4 font-black text-xl ${isHacker && !feedback ? 'text-[#00ff41] font-mono' : 'text-white'}`}>
                    <div className="flex items-center gap-2 bg-black/40 px-4 py-2 rounded-md border-b-4 border-black/20"><Star fill={isHacker ? "#00ff41" : "#e29e00"} className={isHacker ? "text-[#00ff41]" : "text-[#e29e00]"} /> {score}</div>
                    
                    {difficulty === 'rookie' && (
                        <div className="flex items-center relative">
                            <div className="relative w-12 h-10 mr-2">
                                <Brain className="absolute text-gray-600 w-full h-full opacity-50" strokeWidth={1} />
                                <div className="absolute bottom-0 left-0 w-full overflow-hidden transition-all duration-500" style={{ height: `${(score / totalQ) * 100}%` }}>
                                    <Brain className={`w-full h-10 absolute bottom-0 left-0 ${score/totalQ >= 1 ? 'text-purple-400 drop-shadow-[0_0_10px_rgba(168,85,247,0.8)]' : score/totalQ >= 0.8 ? 'text-yellow-400' : score/totalQ >= 0.5 ? 'text-green-400' : 'text-blue-400'} fill-current`} strokeWidth={0} />
                                </div>
                                <Brain className="absolute text-white w-full h-full" strokeWidth={2} />
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-black/40 px-4 py-2 rounded-md border-b-4 border-black/20 uppercase text-sm">Stage {currentQuestionIndex + 1}/{totalQ}</div>
                    </div>

                    {difficulty === 'rookie' && combo > 1 && (
                        <div className="absolute top-20 right-4 animate-bounce z-50"><div className="bg-orange-500 text-white px-4 py-2 rounded-full font-black border-4 border-yellow-400 shadow-lg rotate-12 flex flex-col items-center"><div className="flex items-center gap-1"><Flame size={20} fill="yellow" className="text-yellow-200" /><span>COMBO x{combo}</span></div>{comboMsg && <div className="text-[10px] text-yellow-100 uppercase tracking-wider">{comboMsg}</div>}</div></div>
                    )}

                    {showBrainLevelUp && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 animate-fade-in">
                            <div className="bg-gradient-to-b from-purple-600 to-indigo-700 p-8 rounded-2xl border-4 border-yellow-400 shadow-[0_0_50px_rgba(250,204,21,0.5)] text-center animate-bounce-short">
                                <div className="text-6xl mb-4 animate-pulse">ðŸ§ âœ¨</div>
                                <h2 className="text-3xl font-black text-white mb-2 drop-shadow-md">OTAK KAMU<br/><span className="text-yellow-300">NAIK LEVEL!</span></h2>
                            </div>
                        </div>
                    )}

                    <div className={`p-6 rounded-md shadow-2xl max-w-md w-full text-center border-b-8 relative ${isHacker ? `bg-[#161b22] ${borderClass} shadow-[0_0_30px_rgba(0,255,65,0.1)]` : 'bg-[#393b3d] border-[#1a1c1e]'}`}>
                        
                        {(feedback === 'wrong' || feedback === 'timeout') && <div className="absolute inset-0 flex items-center justify-center z-20 pointer-events-none animate-ping"><span className="text-6xl font-black text-white drop-shadow-[0_4px_0_#000]">OOF!</span></div>}
                        {feedback === 'correct' && <div className="absolute inset-0 flex items-center justify-center z-20 pointer-events-none animate-bounce-short"><span className={`text-6xl font-black drop-shadow-[0_4px_0_#000] stroke-black ${isHacker ? 'text-[#00ff41]' : 'text-[#e29e00]'}`}>GG!</span></div>}

                        <div className="h-6 bg-[#1a1c1e] w-full rounded-sm mb-6 p-1"><div className={`h-full rounded-sm transition-all duration-100 ease-linear ${progressPercent < 30 ? 'bg-[#f44336]' : (isHacker ? 'bg-[#00ff41]' : 'bg-[#00b0f4]')}`} style={{ width: `${progressPercent}%` }}></div></div>

                        {operation === 'hacker_balloon' ? (
                            <div className="mb-6 relative h-[500px] w-full flex justify-center items-center">
                                <div className="absolute z-20 flex flex-col items-center"><div className="text-[#00ff41] font-mono text-xs font-bold mb-2 uppercase">TEMUKAN JAWABAN</div><div className="flex gap-2 items-center bg-black/50 p-4 rounded-xl border-2 border-[#00ff41]"><div className={`w-16 h-20 rounded-[50%] flex items-center justify-center border-b-4 ${currentQ.missingPart === 0 ? 'bg-gray-800 border-gray-600' : 'bg-[#f44336] border-[#b02e21]'}`}><span className="text-2xl font-black text-white">{currentQ.missingPart === 0 ? '?' : currentQ.num1}</span></div><span className="text-white font-black text-xl">x</span><div className={`w-16 h-20 rounded-[50%] flex items-center justify-center border-b-4 ${currentQ.missingPart === 1 ? 'bg-gray-800 border-gray-600' : 'bg-[#e29e00] border-[#b37d00]'}`}><span className="text-2xl font-black text-white">{currentQ.missingPart === 1 ? '?' : currentQ.num2}</span></div><span className="text-white font-black text-xl">=</span><div className={`w-16 h-20 rounded-[50%] flex items-center justify-center border-b-4 ${currentQ.missingPart === 2 ? 'bg-gray-800 border-gray-600' : 'bg-[#00b0f4] border-[#0077a6]'}`}><span className="text-2xl font-black text-white">{currentQ.missingPart === 2 ? '?' : currentQ.product}</span></div></div></div>
                                {currentQ.options.map((opt, i) => {
                                    const isPopped = poppedBalloons.includes(i);
                                    if (isPopped) return null;
                                    const borderClass = opt.color.replace('500', '700');
                                    return (<div key={i} onClick={() => handleBalloonClick(opt.val, i)} className={`absolute w-14 h-16 rounded-[50%] flex items-center justify-center border-b-4 shadow-lg cursor-pointer hover:scale-110 active:scale-95 transition-transform z-10 ${opt.color} border-${borderClass.replace('bg-', '')}`} style={{ transform: `translate(${opt.x}px, ${opt.y}px)` }}><span className="text-white font-black text-lg drop-shadow-md">{opt.val}</span><div className="absolute -bottom-2 w-[1px] h-4 bg-white/50"></div></div>);
                                })}
                            </div>
                        ) : operation === 'hacker_algebra' ? (
                            <div className="mb-4">
                                <div className="mb-6 p-2 rounded border border-[#00ff41]/20 bg-[#00ff41]/5"><div className="text-[#00ff41] font-mono text-[10px] font-bold text-center mb-2 tracking-[0.2em]">DECRYPT_KEY_V.{currentQuestionIndex + 1}.0</div><div className="grid grid-cols-5 gap-2">{currentQ.keyMap.map((iconName, idx) => (<div key={idx} className="flex flex-col items-center p-1 bg-black border border-[#00ff41]/30 rounded"><span className="text-[#00ff41] font-mono text-xs font-bold mb-1">{idx + 1}</span>{renderIcon(iconName, 20)}</div>))}</div></div>
                                <div className="rounded-md p-6 border-4 bg-black border-[#00ff41] text-[#00ff41]"><div className="text-5xl font-black font-mono flex justify-center items-center gap-2">{renderIcon(currentQ.keyMap[currentQ.val1 - 1], 48)}<span className="text-white mx-2">{currentQ.symbol}</span>{renderIcon(currentQ.keyMap[currentQ.val2 - 1], 48)}<span className="text-white mx-2">=</span><span className="text-white animate-pulse">?</span></div></div>
                            </div>
                        ) : operation === 'hacker_circle' ? (
                            <div className="flex flex-col items-center">
                                <div className="mb-4 relative h-80 w-80 flex justify-center items-center font-mono">
                                    <div className="absolute top-0 text-[#00ff41] text-xs font-bold animate-pulse z-20 bg-black px-2 border border-[#00ff41] rounded">â–¼ TARGET ZONE â–¼</div>
                                    <div className="absolute w-72 h-72 rounded-full border-[12px] border-dashed border-[#00ff41]/30 flex items-center justify-center transition-transform duration-300" style={{ transform: `rotate(${ringOutRot * 36}deg)` }}><div className="absolute inset-0 rounded-full border-2 border-[#00ff41]/20"></div>{currentQ.outOptions.map((val, i) => (<div key={i} className="absolute text-[#00ff41] font-bold text-xl flex justify-center items-center h-8 w-8" style={{ transform: `rotate(${i * 36}deg) translate(0, -125px) rotate(-${i * 36 + ringOutRot * 36}deg)` }}>{val !== null ? val : ''}</div>))}</div>
                                    <div className="absolute w-48 h-48 rounded-full border-[8px] border-dashed border-[#00ff41]/60 flex items-center justify-center transition-transform duration-300 bg-[#0d1117]" style={{ transform: `rotate(${ringMidRot * 36}deg)` }}><div className="absolute inset-0 rounded-full border-2 border-[#00ff41]/40"></div>{currentQ.midOptions.map((val, i) => (<div key={i} className="absolute text-[#00ff41] font-bold text-xl flex justify-center items-center h-8 w-8" style={{ transform: `rotate(${i * 36}deg) translate(0, -85px) rotate(-${i * 36 + ringMidRot * 36}deg)` }}>{val}</div>))}</div>
                                    <div className="absolute w-24 h-24 bg-[#00ff41] rounded-full flex items-center justify-center cursor-pointer hover:scale-110 transition-transform shadow-[0_0_20px_#00ff41] active:scale-95 border-4 border-black z-10" onClick={submitCircleAnswer}><div className="text-black font-black text-2xl text-center leading-none">{currentQ.num1}<br/><span className="text-3xl">{currentQ.symbol}</span></div></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 w-full max-w-xs mb-4 font-mono">
                                    <div className="flex flex-col items-center bg-[#161b22] p-2 rounded border border-[#00ff41]/30"><span className="text-[#00ff41] text-xs font-bold mb-1">RING LUAR</span><div className="flex gap-4"><button onClick={() => rotateRing('out', 'ccw')} className="p-2 bg-black border border-[#00ff41] text-[#00ff41] rounded hover:bg-[#00ff41] hover:text-black active:scale-90 transition-all"><RotateCcw size={20} /></button><button onClick={() => rotateRing('out', 'cw')} className="p-2 bg-black border border-[#00ff41] text-[#00ff41] rounded hover:bg-[#00ff41] hover:text-black active:scale-90 transition-all"><RotateCw size={20} /></button></div></div>
                                    <div className="flex flex-col items-center bg-[#161b22] p-2 rounded border border-[#00ff41]/30"><span className="text-[#00ff41] text-xs font-bold mb-1">RING TENGAH</span><div className="flex gap-4"><button onClick={() => rotateRing('mid', 'ccw')} className="p-2 bg-black border border-[#00ff41] text-[#00ff41] rounded hover:bg-[#00ff41] hover:text-black active:scale-90 transition-all"><RotateCcw size={20} /></button><button onClick={() => rotateRing('mid', 'cw')} className="p-2 bg-black border border-[#00ff41] text-[#00ff41] rounded hover:bg-[#00ff41] hover:text-black active:scale-90 transition-all"><RotateCw size={20} /></button></div></div>
                                </div>
                            </div>
                        ) : (
                            <div className={`rounded-md p-6 mb-4 border-4 ${isHacker ? 'bg-black border-[#00ff41] text-[#00ff41]' : 'bg-[#232527] border-[#1a1c1e] text-white'}`}>
                                <div className="text-6xl font-black flex justify-center items-center gap-4">
                                    <span>{currentQ.num1}</span>
                                    <span className={isHacker ? "text-white" : "text-[#00b0f4]"}>{currentQ.symbol}</span>
                                    <span>{currentQ.num2}</span>
                                </div>
                            </div>
                        )}

                        {(!['hacker_balloon', 'hacker_circle'].includes(operation || '')) && (
                            <>
                            <div className={`h-20 flex items-center justify-center text-5xl font-black rounded-md border-4 mb-6 ${feedback === 'correct' ? 'bg-[#00b06f] border-[#008c5a] text-white' : feedback === 'wrong' ? 'bg-[#f44336] border-[#b02e21] text-white' : isHacker ? 'bg-[#0d1117] border-[#30363d] text-[#00ff41]' : 'bg-[#505254] border-[#232527] text-white'}`}>
                                {userAnswer || <span className="animate-pulse text-gray-500">?</span>}
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                    <button key={n} onClick={() => handleAnswer(n.toString())} className={`active:translate-y-1 active:border-b-0 rounded-sm border-b-4 p-3 text-2xl font-black transition-all ${isHacker ? 'bg-[#21262d] border-[#30363d] text-[#c9d1d9] hover:bg-[#30363d]' : 'bg-[#9ca3af] hover:bg-[#d1d5db] active:bg-[#6b7280] border-[#4b5563] text-[#1f2937]'}`}>{n}</button>
                                ))}
                                <button onClick={deleteAnswer} className="bg-[#f44336] hover:bg-[#ff5f52] active:translate-y-1 active:border-b-0 rounded-sm border-b-4 border-[#b02e21] p-3 text-xl font-black text-white">DEL</button>
                                <button onClick={() => handleAnswer('0')} className={`active:translate-y-1 active:border-b-0 rounded-sm border-b-4 p-3 text-2xl font-black ${isHacker ? 'bg-[#21262d] border-[#30363d] text-[#c9d1d9] hover:bg-[#30363d]' : 'bg-[#9ca3af] hover:bg-[#d1d5db] active:translate-y-1 border-[#4b5563] text-[#1f2937]'}`}>0</button>
                                <button onClick={submitAnswer} disabled={userAnswer === ''} className={`active:translate-y-1 active:border-b-0 disabled:opacity-50 disabled:active:translate-y-0 text-white rounded-sm border-b-4 p-3 text-xl font-black shadow-lg transition-all ${isHacker ? 'bg-[#00ff41] text-black border-[#00ce35] hover:bg-[#00ff41]/90' : 'bg-[#00b06f] hover:bg-[#00c07f] border-[#008c5a]'}`}>ENTER</button>
                            </div>
                            </>
                        )}
                    </div>
                </div>
                );
            }

            if (appState === 'result') {
                let title = ""; let emoji = null; let color = "";
                const maxScore = questions.length;
                const percentage = (score / maxScore) * 100;
                const message = getMotivationalMessage(score, maxScore, difficulty);
                const isHacker = difficulty === 'legend';

                if (percentage === 100) { title = isHacker ? "SYSTEM HACKED!" : "HACKER LEVEL!"; emoji = <Crown size={80} className={`${isHacker ? 'text-[#00ff41]' : 'text-[#e29e00]'} animate-bounce`} />; color = isHacker ? "text-[#00ff41]" : "text-[#e29e00]"; }
                else if (percentage >= 80) { title = "PRO PLAYER!"; emoji = <Trophy size={80} className="text-[#00b0f4] animate-pulse" />; color = "text-[#00b0f4]"; }
                else if (percentage >= 50) { title = "NOOB BERBAKAT"; emoji = <Medal size={80} className="text-[#00b06f]" />; color = "text-[#00b06f]"; }
                else { title = "TOTAL OOF!"; emoji = <Skull size={80} className="text-[#f44336]" />; color = "text-[#f44336]"; }
                
                return (
                <div className={`min-h-screen flex flex-col items-center justify-center p-4 font-sans ${isHacker ? 'bg-[#0d1117]' : 'bg-[#111]'}`}>
                    <div className="absolute inset-0 opacity-20" style={{ backgroundImage: 'repeating-linear-gradient(45deg, #333 0, #333 1px, transparent 0, transparent 50%)', backgroundSize: '10px 10px' }}></div>
                    <div className={`p-8 rounded-md shadow-[0_0_50px_rgba(0,0,0,0.5)] max-w-md w-full text-center border-4 z-10 animate-fade-in relative ${isHacker ? 'bg-[#161b22] border-[#00ff41]' : 'bg-[#232527] border-[#393b3d]'}`}>
                    <div className="flex justify-center mb-6"><div className={`p-4 rounded-full border-4 ${isHacker ? 'bg-black border-[#00ff41]' : 'bg-[#1a1c1e] border-[#393b3d]'}`}>{emoji}</div></div>
                    <h2 className={`text-4xl font-black ${color} mb-2 uppercase drop-shadow-[0_2px_0_#000] ${isHacker ? 'font-mono' : ''}`}>{title}</h2>
                    <div className={`rounded-md p-4 mb-6 border ${isHacker ? 'bg-black border-[#00ff41] text-[#00ff41]' : 'bg-[#1a1c1e] border-[#393b3d] text-white'}`}><p className="font-bold uppercase text-xs mb-1 tracking-widest opacity-70">FINAL SCORE</p><div className="text-6xl font-black">{score} <span className="text-2xl opacity-50">/ {maxScore}</span></div></div>
                    <p className={`font-bold text-lg mb-8 italic leading-relaxed border-l-4 pl-4 text-left py-2 ${isHacker ? 'text-[#00ff41] border-[#00ff41] bg-[#00ff41]/10 font-mono' : 'text-gray-300 border-[#00b0f4] bg-[#00000030]'}`}>"{message}"</p>
                    <div className="flex gap-3">
                        <button onClick={() => { playSFX('click-menu'); setAppState(difficulty === 'legend' ? 'hacker_menu' : (difficulty === 'pro' ? 'pro_menu' : 'rookie_menu')); }} className="flex-1 bg-[#393b3d] hover:bg-[#4b4d4f] text-white font-black py-4 rounded-md border-b-4 border-[#1a1c1e] active:border-b-0 active:translate-y-1 transition-all uppercase">GANTI MISI</button>
                        <button onClick={() => { playSFX('click-menu'); if (selectedTable !== null) startIntro(selectedTable); else startIntro(null); }} className={`flex-1 text-white font-black py-4 rounded-md border-b-4 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 uppercase ${isHacker ? 'bg-[#00ff41] text-black border-[#00ce35] hover:bg-[#00ff41]/90' : 'bg-[#00b0f4] hover:bg-[#34c3ff] border-[#0077a6]'}`}><RefreshCcw size={20} /> Re-Spawn</button>
                    </div>
                    <div className="mt-4 flex justify-center"><button onClick={() => { playSFX('click-menu'); playVoiceOver(message); }} className={`flex items-center gap-2 text-xs font-bold uppercase tracking-widest ${isHacker ? 'text-[#00ff41]' : 'text-[#00b0f4] hover:text-white'}`}><Volume2 size={14}/> Replay Voice</button></div>
                    </div>
                </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
